/*! box (v0.1.0 built on 09-08-2013 aa 02:08) */
!function(a,b){"use strict";function c(a,d,e,f){e=e!==b?e:0,f=f!==b?f:0,this.id=++c.id,this.shapeId=a.ShapeID,this.group=0,this.layers=0,this.im=0===e?0:1/e,this.iI=0===f?0:1/f,this.restitution=0,this.staticFriction=.5,this.kineticFriction=.3,this.noFriction=!1,this.position=new m(d.x,d.y),this.pixelPosition=new m(d.x,d.y),this.velocity=new m(0,0),this.angularVelocity=0,this.torque=0,this.orientation=0,this.force=new m(0,0),this.user=null,this.update()}function d(){this.a=null,this.b=null,this.normal=new m(0,0),this.penetration=0,this.minRestitution=0,this.staticFriction=0,this.kineticFriction=0,this.contactCount=0,this.contacts=[new m(0,0),new m(0,0)]}function e(a,b,c){this.gravity=a||new m(0,50),this.steps=b||10,this.iterations=c||10,this.interp=1/this.steps,this.contactCount=0,this.contacts=[],this.statics=[],this.dynamics=[]}function f(a,b,d,e){this.extend=new m(b.x,b.y),this.min=new m(0,0),this.max=new m(0,0),c.call(this,f,a,d,e)}function g(a,b){return a.max.x<b.min.x||a.min.x>b.max.x?!1:a.max.y<b.min.y||a.min.y>b.max.y?!1:!0}function h(a,b,c){var d=b.position.x-c.position.x,e=b.position.y-c.position.y,f=(b.max.x-b.min.x)/2,g=(c.max.x-c.min.x)/2,h=f+g-u(d);if(h>0){var i=(b.max.y-b.min.y)/2,j=(c.max.y-c.min.y)/2,k=i+j-u(e);if(k){if(k>h){a.normal.x=0>d?1:-1,a.normal.y=0,a.penetration=h;var l=a.normal.x>0?c.min.x:c.max.x;return a.contacts[0].x=l,a.contacts[1].x=l,a.contacts[0].y=q(c.min.y,b.min.y),a.contacts[1].y=p(c.max.y,b.max.y),a.contactCount=2,!0}a.normal.x=0,a.normal.y=0>e?1:-1,a.penetration=k;var m=a.normal.y>0?c.min.y:c.max.y;return a.contacts[0].y=m,a.contacts[1].y=m,a.contacts[0].x=q(c.min.x,b.min.x),a.contacts[1].x=p(c.max.x,b.max.x),a.contactCount=2,!0}}return a.contactCount=0,!1}function i(a,b){var c=b.position.x-a.position.x,d=b.position.y-a.position.y,e=a.radius+b.radius;return e*e>c*c+d*d}function j(a,b,c){var d=c.position.x-b.position.x,e=c.position.y-b.position.y,f=v(d*d+e*e),g=b.radius+c.radius;a.contactCount=1,0===f?(a.penetration=b.radius,a.normal.x=1,a.normal.y=0,a.contacts[0].x=b.position.x,a.contacts[1].y=b.position.y):(a.penetration=g-f,a.normal.x=d/f,a.normal.y=e/f,a.contacts[0].x=a.normal.x*b.radius+b.position.x,a.contacts[0].y=a.normal.y*b.radius+b.position.y)}function k(a,b){return s[a.shapeId][b.shapeId](a,b)}function l(a,b,c){var d,e=t[b.shapeId][c.shapeId];return(d=e[0](a,b,c))&&e[1]&&(a.normal.x=-a.normal.x,a.normal.y=-a.normal.y),d}function m(a,b){this.x=a,this.y=b}function n(a,b,c){if(b&&(a.prototype=Object.create(b.prototype)),c)for(var d in c)c.hasOwnProperty(d)&&(a.prototype[d]=c[d])}function o(a){var b=a-(0|a);return~~(a+b)}function p(a,b){return b>a?a:b}function q(a,b){return a>b?a:b}c.id=0,n(c,null,{update:function(){this.pixelPosition.x=o(this.position.x),this.pixelPosition.y=o(this.position.y)},integrateForces:function(a,b){0!==this.im&&(this.velocity.x+=(this.force.x*this.im+b.x)*(a/2),this.velocity.y+=(this.force.y*this.im+b.y)*(a/2),this.angularVelocity+=this.torque*this.iI*(a/2))},integrateVelocity:function(a,b){0!==this.im&&(this.position.x+=this.velocity.x*a,this.position.y+=this.velocity.y*a,this.orientation+=this.angularVelocity*a,this.integrateForces(a,b))},applyImpulse:function(a,b,c,d){this.velocity.x+=this.im*a,this.velocity.y+=this.im*b,this.angularVelocity+=this.iI*(c*b-d*a)},applyForce:function(a,b){this.force.x+=a,this.force.y+=b},clearForces:function(){this.force.x=0,this.force.y=0},clearContacts:function(){this.contactCount=0}}),d.prototype={initializeWithBodies:function(a,b){return this.a=a,this.b=b,l(this,a,b)},setup:function(a,b){this.minRestitution=p(this.a.restitution,this.b.restitution),this.staticFriction=v(this.a.staticFriction*this.b.staticFriction),this.kineticFriction=v(this.a.kineticFriction*this.b.kineticFriction);for(var c=0;c<this.contactCount;c++){var d=this.getRelativeVelocityX(this.contacts[c],this.a,this.b),e=this.getRelativeVelocityY(this.contacts[c],this.a,this.b),f=a*b.x*b.x+a*b.y*b.y;if(f+r>d*d+e*e){this.minRestitution=0;break}}},resolveAllContacts:function(){for(var a=0;a<this.contactCount;a++)this.resolveContactPoint(this.contacts[a],this.a,this.b)},resolveContactPoint:function(a,b,c){var d=a.x-b.position.x,e=a.y-b.position.y,f=a.x-c.position.x,g=a.y-c.position.y,h=this.getRelativeVelocityX(a,b,c),i=this.getRelativeVelocityY(a,b,c),j=h*this.normal.x+i*this.normal.y;if(!(j>0)){var k=d*this.normal.y-e*this.normal.x,l=f*this.normal.y-g*this.normal.x,m=b.im+c.im+k*k*b.iI+l*l*c.iI,n=-(1+this.minRestitution)*j;if(n/=m,n/=this.contactCount,b.applyImpulse(-n*this.normal.x,-n*this.normal.y,d,e),c.applyImpulse(n*this.normal.x,n*this.normal.y,f,g),!this.noFriction){var o=h-this.normal.x*j,p=i-this.normal.y*j,q=v(o*o+p*p);q>r&&(o/=q,p/=q);var s=-(h*o+i*p);s/=m,s/=this.contactCount,u(s)<r||(u(s)<n*this.staticFriction?(o*=s,p*=s):(o=o*-n*this.kineticFriction,p=p*-n*this.kineticFriction),b.applyImpulse(-o,-p,d,e),c.applyImpulse(o,p,f,g))}}},correctPositions:function(){var a=this.a,b=this.b,c=.8,d=.02,e=q(this.penetration-d,0)/(a.im+b.im),f=e*this.normal.x*c,g=e*this.normal.y*c;a.position.x-=f*a.im,a.position.y-=g*a.im,b.position.x+=f*b.im,b.position.y+=g*b.im},getRelativeVelocityX:function(a,b,c){var d=a.x-b.velocity.x,e=a.x-c.velocity.x;return c.velocity.x+-c.angularVelocity*e-b.velocity.x- -b.angularVelocity*d},getRelativeVelocityY:function(a,b,c){var d=a.y-b.velocity.y,e=a.y-c.velocity.y;return c.velocity.y+c.angularVelocity*e-b.velocity.y-b.angularVelocity*d}};var r=1e-4;e.EPSILON=r,e.prototype={update:function(a){var b,c;for(b=0;b<this.steps;b++)this.step(a*this.interp);for(b=0,c=this.dynamics.length;c>b;b++)this.dynamics[b].clearForces()},add:function(a){0!==a.im?this.dynamics.push(a):this.statics.push(a)},remove:function(a){this.statics.splice(this.statics.indexOf(a),1),this.dynamics.splice(this.dynamics.indexOf(a),1)},step:function(a){var b,c,d=this.dynamics.length;for(this.findContacts(),b=0;d>b;b++)this.dynamics[b].integrateForces(a,this.gravity),this.dynamics[b].clearContacts();for(c=0;c<this.contactCount;c++)this.contacts[c].setup(a,this.gravity);for(b=0;b<this.iterations;b++)for(c=0;c<this.contactCount;c++)this.contacts[c].resolveAllContacts();for(b=0;d>b;b++)this.dynamics[b].integrateVelocity(a,this.gravity);for(c=0;c<this.contactCount;c++)this.contacts[c].correctPositions();for(b=0;d>b;b++)this.dynamics[b].update()},findContacts:function(){var a=this.dynamics.length,b=this.statics.length;this.contactCount=0;for(var c=0;a>c;c++){for(var d=this.dynamics[c],e=0;b>e;e++)this.checkAndSolveCollision(d,this.statics[e]);for(e=c+1;a>e;e++)this.checkAndSolveCollision(d,this.dynamics[e])}},checkAndSolveCollision:function(a,b){var c;k(a,b)&&(this.contacts.length===this.contactCount?this.contacts.push(c=new d):c=this.contacts[this.contactCount],c.initializeWithBodies(a,b)&&this.contactCount++)}},a.World=e,f.ShapeID=0,n(f,c,{update:function(){this.min.x=this.position.x-this.extend.x,this.max.x=this.position.x+this.extend.x,this.min.y=this.position.y-this.extend.y,this.max.y=this.position.y+this.extend.y,c.prototype.update.call(this)},containsAABB:function(a){return this.min.x<=a.min.x&&this.max.x>=a.max.x&&this.min.y<=a.min.y&&this.max.y>=a.max.y},containsVector:function(a){return this.min.x<=a.x&&this.max.x>=a.x&&this.min.y<=a.y&&this.max.y>=a.y}}),a.AABB=f;var s=[[g],[i]],t=[[[h,!1]],[[j,!1]]];m.prototype={add:function(a){return new m(this.x+a.x,this.y+a.y)},sub:function(a){return new m(this.x-a.x,this.y-a.y)},dot:function(a){return this.x*a.x+this.y*a.y},cross:function(a){return this.x*a.y-this.y*a.x},div:function(a){return this.x/=a,this.y/=a,this},mul:function(a){return this.x*=a,this.y*=a,this},unit:function(){var a=this.length();if(a>1e-4){var b=1/a;return new m(this.x*b,this.y*b)}return new m(this.x,this.y)},normalize:function(){var a=this.length();if(a>1e-4){var b=1/a;this.x*=b,this.y*=b}},angle:function(){return Math.atan2(this.y,this.x)},lengthSqr:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},a.Vector2=m;var u=Math.abs,v=Math.sqrt;a.round=o}("undefined"==typeof module?window.Box={}:module.exports);