/*! box (v0.1.0 built on 11-08-2013 aa 12:08) */
!function(a,b){"use strict";function c(a,d,e,f){e=e!==b?e:0,f=f!==b?f:0,this.im=0===e?0:1/e,this.iI=0===f?0:1/f,this.position=new q(d.x,d.y),this.pixelPosition=new q(d.x,d.y),this.force=new q(0,0),this.velocity=new q(0,0),this.angularVelocity=0,this.torque=0,this.orientation=0,this.id=++c.id,this.shapeId=a.ShapeID,this.group=0,this.layers=0,this.restitution=0,this.staticFriction=.4,this.kineticFriction=.2,this.hasFriction=!0,this.user=null,this.update(),Object.seal(this)}function d(){this.a=null,this.b=null,this.normal=new q(0,0),this.penetration=0,this.minRestitution=0,this.staticFriction=0,this.kineticFriction=0,this.contactCount=0,this.contacts=[new q(0,0),new q(0,0)],Object.seal(this)}function e(a,b,c){this.gravity=a||new q(0,50),this.contactCount=0,this.contacts=[],this._steps=b||10,this._iterations=c||10,this._interp=1/this._steps,this._statics=[],this._dynamics=[],Object.seal(this)}function f(a,b,d,e){this.extend=new q(b.x,b.y),this.min=new q(0,0),this.max=new q(0,0),c.call(this,f,a,d,e)}function g(a,b,d,e){this.radius=b,c.call(this,g,a,d,e)}function h(a,b){return a.max.x<b.min.x||a.min.x>b.max.x?!1:a.max.y<b.min.y||a.min.y>b.max.y?!1:!0}function i(a,b,c){var d=b.position.x-c.position.x,e=b.position.y-c.position.y,f=b.extend.x+c.extend.x-Math.abs(d);if(f>0){var g=b.extend.y+c.extend.y-Math.abs(e);if(g){if(g>f){a.normal.x=0>d?1:-1,a.normal.y=0,a.penetration=f;var h=a.normal.x>0?c.min.x:c.max.x;return a.contacts[0].x=h,a.contacts[1].x=h,a.contacts[0].y=Math.max(c.min.y,b.min.y),a.contacts[1].y=Math.min(c.max.y,b.max.y),a.contactCount=2,!0}a.normal.x=0,a.normal.y=0>e?1:-1,a.penetration=g;var i=a.normal.y>0?c.min.y:c.max.y;return a.contacts[0].y=i,a.contacts[1].y=i,a.contacts[0].x=Math.max(c.min.x,b.min.x),a.contacts[1].x=Math.min(c.max.x,b.max.x),a.contactCount=2,!0}}return a.contactCount=0,!1}function j(a,b){var c=b.position.x-a.position.x,d=b.position.y-a.position.y,e=a.radius+b.radius;return e*e>c*c+d*d}function k(a,b,c){var d=c.position.x-b.position.x,e=c.position.y-b.position.y,f=Math.sqrt(d*d+e*e),g=b.radius+c.radius;return a.contactCount=1,0===f?(a.penetration=b.radius,a.normal.x=1,a.normal.y=0,a.contacts[0].x=b.position.x,a.contacts[0].y=b.position.y,!0):(a.penetration=g-f,a.normal.x=d/f,a.normal.y=e/f,a.contacts[0].x=a.normal.x*b.radius+b.position.x,a.contacts[0].y=a.normal.y*b.radius+b.position.y,!0)}function l(a,b){var c=a.position.x-b.position.x,d=a.position.y-b.position.y,e=a.radius+b.extend.x-Math.abs(c),f=a.radius+b.extend.y-Math.abs(d);return e>0&&f>0}function m(a,b,c){var d=b.position.x-c.position.x,e=b.position.y-c.position.y,f=d>0?c.extend.x:-c.extend.x,g=e>0?c.extend.y:-c.extend.y,h=0,i=0;Math.abs(d)>c.extend.x&&Math.abs(e)>c.extend.y?(h=c.position.x+f,i=c.position.y+g):(e<-c.extend.y||e>c.extend.y)&&d<c.extend.x&&d>-c.extend.x?(h=c.position.x+d,i=c.position.y+g):(h=c.position.x+f,i=c.position.y+e);var j=h-b.position.x,k=i-b.position.y;if(j*j+k*k<=b.radius*b.radius){var l=Math.sqrt(j*j+k*k);return a.normal.x=j/l,a.normal.y=k/l,a.contacts[0].x=h,a.contacts[0].y=i,a.penetration=b.radius-l,a.contactCount=1,!0}return a.contactCount=0,!1}function n(a,b){this.func=a,this.inverted=!!b}function o(a,b){var c=u[a.shapeId][b.shapeId];return c.inverted?c.func(b,a):c.func(a,b)}function p(a,b,c){var d,e=v[b.shapeId][c.shapeId];return e.inverted?(d=e.func(a,c,b),d&&(a.normal.x=-a.normal.x,a.normal.y=-a.normal.y)):d=e.func(a,b,c),d}function q(a,b){this.x=a,this.y=b,Object.seal(this)}function r(a,b,c){if(b&&(a.prototype=Object.create(b.prototype)),c)for(var d in c)c.hasOwnProperty(d)&&(a.prototype[d]=c[d])}function s(a){var b=a-(0|a);return~~(a+b)}c.id=0,r(c,null,{update:function(){this.pixelPosition.x=s(this.position.x),this.pixelPosition.y=s(this.position.y)},integrateForces:function(a,b){0!==this.im&&(this.velocity.x+=(this.force.x*this.im+b.x)*(a/2),this.velocity.y+=(this.force.y*this.im+b.y)*(a/2),this.angularVelocity+=this.torque*this.iI*(a/2))},integrateVelocity:function(a,b){0!==this.im&&(this.position.x+=this.velocity.x*a,this.position.y+=this.velocity.y*a,this.orientation+=this.angularVelocity*a,this.integrateForces(a,b))},applyImpulse:function(a,b){this.applyRawImpulse(a.x,a.y,b.x,b.y)},applyRawImpulse:function(a,b,c,d){this.velocity.x+=this.im*a,this.velocity.y+=this.im*b,this.angularVelocity+=this.iI*(c*b-d*a)},applyRawForce:function(a,b){this.force.x+=a,this.force.y+=b},computeMass:function(){},clearForces:function(){this.force.x=0,this.force.y=0}}),d.prototype={initializeWithBodies:function(a,b){return this.a=a,this.b=b,p(this,a,b)},setup:function(a,b){this.minRestitution=Math.min(this.a.restitution,this.b.restitution),this.staticFriction=Math.sqrt(this.a.staticFriction*this.b.staticFriction),this.kineticFriction=Math.sqrt(this.a.kineticFriction*this.b.kineticFriction);for(var c=0;c<this.contactCount;c++){var d=this.getRelativeVelocityX(this.contacts[c],this.a,this.b),e=this.getRelativeVelocityY(this.contacts[c],this.a,this.b),f=a*b.x*b.x+a*b.y*b.y;if(f+t>d*d+e*e){this.minRestitution=0;break}}},resolveAllContacts:function(){for(var a=0;a<this.contactCount;a++)this.resolveContactPoint(this.contacts[a],this.a,this.b)},resolveContactPoint:function(a,b,c){var d=this.getRelativeVelocityX(a,b,c),e=this.getRelativeVelocityY(a,b,c),f=d*this.normal.x+e*this.normal.y;0>=f&&this.applyResponseImpulse(a,b,c,f)},applyResponseImpulse:function(a,b,c,d){var e=a.x-b.position.x,f=a.y-b.position.y,g=a.x-c.position.x,h=a.y-c.position.y,i=this.getMassSum(b,c,e,f,g,h),j=-(1+this.minRestitution)*d;j/=i,j/=this.contactCount,b.applyRawImpulse(-j*this.normal.x,-j*this.normal.y,e,f),c.applyRawImpulse(j*this.normal.x,j*this.normal.y,g,h),b.hasFriction&&this.applyFrictionImpulse(a,b,c,j,i,e,f,g,h)},applyFrictionImpulse:function(a,b,c,d,e,f,g,h,i){var j=this.getRelativeVelocityX(a,b,c),k=this.getRelativeVelocityY(a,b,c),l=j*this.normal.x+k*this.normal.y,m=j-this.normal.x*l,n=k-this.normal.y*l,o=Math.sqrt(m*m+n*n);o>t&&(m/=o,n/=o);var p=-(j*m+k*n);p/=e,p/=this.contactCount,Math.abs(p)>=t&&(Math.abs(p)<d*this.staticFriction?(m*=p,n*=p):(m=m*-d*this.kineticFriction,n=n*-d*this.kineticFriction),b.applyRawImpulse(-m,-n,f,g),c.applyRawImpulse(m,n,h,i))},correctPositions:function(){var a=this.a,b=this.b,c=.8,d=.02,e=Math.max(this.penetration-d,0)/(a.im+b.im),f=e*this.normal.x*c,g=e*this.normal.y*c;a.position.x-=f*a.im,a.position.y-=g*a.im,b.position.x+=f*b.im,b.position.y+=g*b.im},getMassSum:function(a,b,c,d,e,f){var g=c*this.normal.y-d*this.normal.x,h=e*this.normal.y-f*this.normal.x;return a.im+b.im+g*g*a.iI+h*h*b.iI},getRelativeVelocityX:function(a,b,c){return c.velocity.x+-c.angularVelocity*(a.y-c.position.y)-b.velocity.x- -b.angularVelocity*(a.y-b.position.y)},getRelativeVelocityY:function(a,b,c){return c.velocity.y+c.angularVelocity*(a.x-c.position.x)-b.velocity.y-b.angularVelocity*(a.x-b.position.x)}};var t=1e-4;e.EPSILON=t,e.prototype={update:function(a){var b,c;for(b=0;b<this._steps;b++)this.step(a*this._interp);for(b=0,c=this._dynamics.length;c>b;b++)this._dynamics[b].clearForces()},add:function(a){0!==a.im?this._dynamics.push(a):this._statics.push(a)},remove:function(a){this._statics.splice(this._statics.indexOf(a),1),this._dynamics.splice(this._dynamics.indexOf(a),1)},step:function(a){var b,c,d=this._dynamics.length;for(this.findContacts(),b=0;d>b;b++)this._dynamics[b].integrateForces(a,this.gravity);for(c=0;c<this.contactCount;c++)this.contacts[c].setup(a,this.gravity);for(b=0;b<this._iterations;b++)for(c=0;c<this.contactCount;c++)this.contacts[c].resolveAllContacts();for(b=0;d>b;b++)this._dynamics[b].integrateVelocity(a,this.gravity);for(c=0;c<this.contactCount;c++)this.contacts[c].correctPositions();for(b=0;d>b;b++)this._dynamics[b].update()},findContacts:function(){var a=this._dynamics.length,b=this._statics.length;this.contactCount=0;for(var c=0;a>c;c++){for(var d=this._dynamics[c],e=0;b>e;e++)this.checkAndSolveCollision(d,this._statics[e]);for(e=c+1;a>e;e++)this.checkAndSolveCollision(d,this._dynamics[e])}},checkAndSolveCollision:function(a,b){var c;o(a,b)&&(this.contacts.length===this.contactCount?this.contacts.push(c=new d):c=this.contacts[this.contactCount],c.initializeWithBodies(a,b)&&this.contactCount++)}},a.World=e,f.ShapeID=0,r(f,c,{update:function(){this.min.x=this.position.x-this.extend.x,this.max.x=this.position.x+this.extend.x,this.min.y=this.position.y-this.extend.y,this.max.y=this.position.y+this.extend.y,c.prototype.update.call(this)},computeMass:function(a){var b=4*a*this.extend.x*this.extend.y;this.im=b?1/b:0},containsAABB:function(a){return this.min.x<=a.min.x&&this.max.x>=a.max.x&&this.min.y<=a.min.y&&this.max.y>=a.max.y},containsVector:function(a){return this.min.x<=a.x&&this.max.x>=a.x&&this.min.y<=a.y&&this.max.y>=a.y}}),a.AABB=f,g.ShapeID=1,r(g,c,{computeMass:function(a){var b=Math.PI*this.radius*this.radius*a,c=b*this.radius*this.radius;this.im=b?1/b:0,this.iI=c?1/c:0}}),a.Circle=g;var u=[[new n(h,!1),new n(l,!0)],[new n(l,!1),new n(j,!1)]],v=[[new n(i,!1),new n(m,!0)],[new n(m,!1),new n(k,!1)]];q.prototype={zero:function(){this.x=0,this.y=0},add:function(a){return new q(this.x+a.x,this.y+a.y)},sub:function(a){return new q(this.x-a.x,this.y-a.y)},dot:function(a){return this.x*a.x+this.y*a.y},cross:function(a){return this.x*a.y-this.y*a.x},div:function(a){return this.x/=a,this.y/=a,this},mul:function(a){return this.x*=a,this.y*=a,this},unit:function(){var a=this.length();if(a>1e-4){var b=1/a;return new q(this.x*b,this.y*b)}return new q(this.x,this.y)},angle:function(){return Math.atan2(this.y,this.x)},lengthSqr:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},a.Vec2=q,a.round=s}("undefined"==typeof module?window.Box={}:module.exports);