/*! box (v0.1.0 built on 09-08-2013 ap 08:08) */
!function(a,b){"use strict";function c(a,d,e,f){e=e!==b?e:0,f=f!==b?f:0,this.id=++c.id,this.shapeId=a.ShapeID,this.group=0,this.layers=0,this.im=0===e?0:1/e,this.iI=0===f?0:1/f,this.restitution=0,this.staticFriction=.4,this.kineticFriction=.2,this.noFriction=!1,this.position=new q(d.x,d.y),this.pixelPosition=new q(d.x,d.y),this.velocity=new q(0,0),this.angularVelocity=0,this.torque=0,this.orientation=0,this.force=new q(0,0),this.user=null,this.update()}function d(){this.a=null,this.b=null,this.normal=new q(0,0),this.penetration=0,this.minRestitution=0,this.staticFriction=0,this.kineticFriction=0,this.contactCount=0,this.contacts=[new q(0,0),new q(0,0)]}function e(a,b,c){this.gravity=a||new q(0,50),this.steps=b||10,this.iterations=c||10,this.interp=1/this.steps,this.contactCount=0,this.contacts=[],this.statics=[],this.dynamics=[]}function f(a,b,d,e){this.extend=new q(b.x,b.y),this.min=new q(0,0),this.max=new q(0,0),c.call(this,f,a,d,e)}function g(a,b,d,e){this.radius=b,c.call(this,g,a,d,e)}function h(a,b){return a.max.x<b.min.x||a.min.x>b.max.x?!1:a.max.y<b.min.y||a.min.y>b.max.y?!1:!0}function i(a,b,c){var d=b.position.x-c.position.x,e=b.position.y-c.position.y,f=b.extend.x+c.extend.x-y(d);if(f>0){var g=b.extend.y+c.extend.y-y(e);if(g){if(g>f){a.normal.x=0>d?1:-1,a.normal.y=0,a.penetration=f;var h=a.normal.x>0?c.min.x:c.max.x;return a.contacts[0].x=h,a.contacts[1].x=h,a.contacts[0].y=u(c.min.y,b.min.y),a.contacts[1].y=t(c.max.y,b.max.y),a.contactCount=2,!0}a.normal.x=0,a.normal.y=0>e?1:-1,a.penetration=g;var i=a.normal.y>0?c.min.y:c.max.y;return a.contacts[0].y=i,a.contacts[1].y=i,a.contacts[0].x=u(c.min.x,b.min.x),a.contacts[1].x=t(c.max.x,b.max.x),a.contactCount=2,!0}}return a.contactCount=0,!1}function j(a,b){var c=b.position.x-a.position.x,d=b.position.y-a.position.y,e=a.radius+b.radius;return e*e>c*c+d*d}function k(a,b,c){var d=c.position.x-b.position.x,e=c.position.y-b.position.y,f=z(d*d+e*e),g=b.radius+c.radius;a.contactCount=1,0===f?(a.penetration=b.radius,a.normal.x=1,a.normal.y=0,a.contacts[0].x=b.position.x,a.contacts[1].y=b.position.y):(a.penetration=g-f,a.normal.x=d/f,a.normal.y=e/f,a.contacts[0].x=a.normal.x*b.radius+b.position.x,a.contacts[0].y=a.normal.y*b.radius+b.position.y)}function l(a,b){var c=a.position.x-b.position.x,d=a.position.y-b.position.y,e=a.radius+b.extend.x-y(c),f=a.radius+b.extend.y-y(d);return e>0&&f>0}function m(a,b,c){var d=b.position.x-c.position.x,e=b.position.y-c.position.y,f=d>0?c.extend.x:-c.extend.x,g=e>0?c.extend.y:-c.extend.y,h=0,i=0;y(d)>c.extend.x&&y(e)>c.extend.y?(h=c.position.x+f,i=c.position.y+g):(e<-c.extend.y||e>c.extend.y)&&d<c.extend.x&&d>-c.extend.x?(h=c.position.x+d,i=c.position.y+g):(h=c.position.x+f,i=c.position.y+e);var j=h-b.position.x,k=i-b.position.y;if(j*j+k*k<=b.radius*b.radius){var l=z(j*j+k*k);return a.normal.x=j/l,a.normal.y=k/l,a.contacts[0].x=h,a.contacts[0].y=i,a.pentration=b.radius-l,a.contactCount=1,!0}return a.contactCount=0,!1}function n(a,b){this.func=a,this.inverted=!!b}function o(a,b){var c=w[a.shapeId][b.shapeId];return c.inverted?c.func(b,a):c.func(a,b)}function p(a,b,c){var d,e=x[b.shapeId][c.shapeId];return e.inverted?(d=e.func(a,c,b),d&&(a.normal.x=-a.normal.x,a.normal.y=-a.normal.y)):d=e.func(a,b,c),d}function q(a,b){this.x=a,this.y=b}function r(a,b,c){if(b&&(a.prototype=Object.create(b.prototype)),c)for(var d in c)c.hasOwnProperty(d)&&(a.prototype[d]=c[d])}function s(a){var b=a-(0|a);return~~(a+b)}function t(a,b){return b>a?a:b}function u(a,b){return a>b?a:b}c.id=0,r(c,null,{update:function(){this.pixelPosition.x=s(this.position.x),this.pixelPosition.y=s(this.position.y)},integrateForces:function(a,b){0!==this.im&&(this.velocity.x+=(this.force.x*this.im+b.x)*(a/2),this.velocity.y+=(this.force.y*this.im+b.y)*(a/2),this.angularVelocity+=this.torque*this.iI*(a/2))},integrateVelocity:function(a,b){0!==this.im&&(this.position.x+=this.velocity.x*a,this.position.y+=this.velocity.y*a,this.orientation+=this.angularVelocity*a,this.integrateForces(a,b))},applyImpulse:function(a,b,c,d){this.velocity.x+=this.im*a,this.velocity.y+=this.im*b,this.angularVelocity+=this.iI*(c*b-d*a)},applyForce:function(a,b){this.force.x+=a,this.force.y+=b},computeMass:function(){},clearForces:function(){this.force.x=0,this.force.y=0}}),d.prototype={initializeWithBodies:function(a,b){return this.a=a,this.b=b,p(this,a,b)},setup:function(a,b){this.minRestitution=t(this.a.restitution,this.b.restitution),this.staticFriction=z(this.a.staticFriction*this.b.staticFriction),this.kineticFriction=z(this.a.kineticFriction*this.b.kineticFriction);for(var c=0;c<this.contactCount;c++){var d=this.getRelativeVelocityX(this.contacts[c],this.a,this.b),e=this.getRelativeVelocityY(this.contacts[c],this.a,this.b),f=a*b.x*b.x+a*b.y*b.y;if(f+v>d*d+e*e){this.minRestitution=0;break}}},resolveAllContacts:function(){for(var a=0;a<this.contactCount;a++)this.resolveContactPoint(this.contacts[a],this.a,this.b)},resolveContactPoint:function(a,b,c){var d=a.x-b.position.x,e=a.y-b.position.y,f=a.x-c.position.x,g=a.y-c.position.y,h=this.getRelativeVelocityX(a,b,c),i=this.getRelativeVelocityY(a,b,c),j=h*this.normal.x+i*this.normal.y;if(!(j>0)){var k=d*this.normal.y-e*this.normal.x,l=f*this.normal.y-g*this.normal.x,m=b.im+c.im+k*k*b.iI+l*l*c.iI,n=-(1+this.minRestitution)*j;if(n/=m,n/=this.contactCount,b.applyImpulse(-n*this.normal.x,-n*this.normal.y,d,e),c.applyImpulse(n*this.normal.x,n*this.normal.y,f,g),!this.noFriction){h=this.getRelativeVelocityX(a,b,c),i=this.getRelativeVelocityY(a,b,c),j=h*this.normal.x+i*this.normal.y;var o=h-this.normal.x*j,p=i-this.normal.y*j,q=z(o*o+p*p);q>v&&(o/=q,p/=q);var r=-(h*o+i*p);r/=m,r/=this.contactCount,y(r)<v||(y(r)<n*this.staticFriction?(o*=r,p*=r):(o=o*-n*this.kineticFriction,p=p*-n*this.kineticFriction),b.applyImpulse(-o,-p,d,e),c.applyImpulse(o,p,f,g))}}},correctPositions:function(){var a=this.a,b=this.b,c=.8,d=.02,e=u(this.penetration-d,0)/(a.im+b.im),f=e*this.normal.x*c,g=e*this.normal.y*c;a.position.x-=f*a.im,a.position.y-=g*a.im,b.position.x+=f*b.im,b.position.y+=g*b.im},getRelativeVelocityX:function(a,b,c){var d=a.y-b.position.y,e=a.y-c.position.y;return c.velocity.x+-c.angularVelocity*e-b.velocity.x- -b.angularVelocity*d},getRelativeVelocityY:function(a,b,c){var d=a.x-b.position.x,e=a.x-c.position.x;return c.velocity.y+c.angularVelocity*e-b.velocity.y-b.angularVelocity*d}};var v=1e-4;e.EPSILON=v,e.prototype={update:function(a){var b,c;for(b=0;b<this.steps;b++)this.step(a*this.interp);for(b=0,c=this.dynamics.length;c>b;b++)this.dynamics[b].clearForces()},add:function(a){0!==a.im?this.dynamics.push(a):this.statics.push(a)},remove:function(a){this.statics.splice(this.statics.indexOf(a),1),this.dynamics.splice(this.dynamics.indexOf(a),1)},step:function(a){var b,c,d=this.dynamics.length;for(this.findContacts(),b=0;d>b;b++)this.dynamics[b].integrateForces(a,this.gravity);for(c=0;c<this.contactCount;c++)this.contacts[c].setup(a,this.gravity);for(b=0;b<this.iterations;b++)for(c=0;c<this.contactCount;c++)this.contacts[c].resolveAllContacts();for(b=0;d>b;b++)this.dynamics[b].integrateVelocity(a,this.gravity);for(c=0;c<this.contactCount;c++)this.contacts[c].correctPositions();for(b=0;d>b;b++)this.dynamics[b].update()},findContacts:function(){var a=this.dynamics.length,b=this.statics.length;this.contactCount=0;for(var c=0;a>c;c++){for(var d=this.dynamics[c],e=0;b>e;e++)this.checkAndSolveCollision(d,this.statics[e]);for(e=c+1;a>e;e++)this.checkAndSolveCollision(d,this.dynamics[e])}},checkAndSolveCollision:function(a,b){var c;o(a,b)&&(this.contacts.length===this.contactCount?this.contacts.push(c=new d):c=this.contacts[this.contactCount],c.initializeWithBodies(a,b)&&this.contactCount++)}},a.World=e,f.ShapeID=0,r(f,c,{update:function(){this.min.x=this.position.x-this.extend.x,this.max.x=this.position.x+this.extend.x,this.min.y=this.position.y-this.extend.y,this.max.y=this.position.y+this.extend.y,c.prototype.update.call(this)},computeMass:function(a){var b=4*a*this.extend.x*this.extend.y;this.im=b?1/b:0},containsAABB:function(a){return this.min.x<=a.min.x&&this.max.x>=a.max.x&&this.min.y<=a.min.y&&this.max.y>=a.max.y},containsVector:function(a){return this.min.x<=a.x&&this.max.x>=a.x&&this.min.y<=a.y&&this.max.y>=a.y}}),a.AABB=f,g.ShapeID=1,r(g,c,{computeMass:function(a){var b=Math.PI*this.radius*this.radius*a,c=b*this.radius*this.radius;this.im=b?1/b:0,this.iI=c?1/c:0}}),a.Circle=g;var w=[[new n(h,!1),new n(l,!0)],[new n(l,!1),new n(j,!1)]],x=[[new n(i,!1),new n(m,!0)],[new n(m,!1),new n(k,!1)]];q.prototype={add:function(a){return new q(this.x+a.x,this.y+a.y)},sub:function(a){return new q(this.x-a.x,this.y-a.y)},dot:function(a){return this.x*a.x+this.y*a.y},cross:function(a){return this.x*a.y-this.y*a.x},div:function(a){return this.x/=a,this.y/=a,this},mul:function(a){return this.x*=a,this.y*=a,this},unit:function(){var a=this.length();if(a>1e-4){var b=1/a;return new q(this.x*b,this.y*b)}return new q(this.x,this.y)},angle:function(){return Math.atan2(this.y,this.x)},lengthSqr:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},a.Vector2=q;var y=Math.abs,z=Math.sqrt;a.round=s}("undefined"==typeof module?window.Box={}:module.exports);