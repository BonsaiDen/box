/*! box (v0.1.0 built on 08-08-2013 aa 12:08) */
!function(a,b){function c(a,d,f){d=d!==b?d:0,f=f!==b?f:0,this.id=++c.id,this.im=0===d?0:1/d,this.iI=0===f?0:1/f,this.restitution=0,this.staticFriction=.5,this.dynamicFriction=.3,this.noFriction=!1,this.position=new e(a.x,a.y),this.pixelPosition=new e(a.x,a.y),this.velocity=new e(0,0),this.angularVelocity=0,this.torque=0,this.orientation=0,this.force=new e(0,0),this.user=null,this.update()}function d(){this.a=null,this.b=null,this.e=0,this.sf=0,this.df=0,this.normal=new e(0,0),this.penetration=0,this.contacts=[new e(0,0),new e(0,0)],this.contactCount=0}function e(a,b){this.x=a,this.y=b}function f(a,b,c){this.steps=b||10,this.interp=1/this.steps,this.iterations=c||10,this.gravity=a||new e(0,50),this.contacts=[],this.contactCount=0,this.statics=[],this.dynamics=[]}function g(a,b,d,f){this.extend=new e(b.x,b.y),this.min=new e(0,0),this.max=new e(0,0),c.call(this,a,d,f)}function h(){}function i(a,b,c){if(b&&(a.prototype=Object.create(b.prototype)),c)for(var d in c)c.hasOwnProperty(d)&&(a.prototype[d]=c[d])}function j(a){var b=a-(0|a);return~~(a+b)}c.id=0,i(c,null,{update:function(){this.pixelPosition.x=j(this.position.x),this.pixelPosition.y=j(this.position.y)},integrateForces:function(a,b){0!==this.im&&(this.velocity.x+=(this.force.x*this.im+b.x)*(a/2),this.velocity.y+=(this.force.y*this.im+b.y)*(a/2),this.angularVelocity+=this.torque*this.iI*(a/2))},integrateVelocity:function(a,b){0!==this.im&&(this.position.x+=this.velocity.x*a,this.position.y+=this.velocity.y*a,this.orientation+=this.angularVelocity*a,this.integrateForces(a,b))},applyImpulse:function(a,b,c,d){this.velocity.x+=this.im*a,this.velocity.y+=this.im*b,this.angularVelocity+=this.iI*(c*b-d*a)},applyForce:function(a,b){this.force.x+=a,this.force.y+=b},clearForces:function(){this.force.x=0,this.force.y=0},clearContacts:function(){this.contacts=0,this.contactCount=0}}),d.prototype={init:function(a,b){return this.a=a,this.b=b,h.AABBvsAABB(this,a,b)},setup:function(a,b){this.e=Math.min(this.a.restitution,this.b.restitution),this.sf=Math.sqrt(this.a.staticFriction*this.b.staticFriction),this.df=Math.sqrt(this.a.dynamicFriction*this.b.dynamicFriction);for(var c=0;c<this.contactCount;c++){var d=this.getRelativeVelocityX(this.contacts[c],this.a,this.b),e=this.getRelativeVelocityY(this.contacts[c],this.a,this.b),f=a*b.x*b.x+a*b.y*b.y;f+k>d*d+e*e&&(this.e=0)}},resolve:function(){for(var a=0;a<this.contactCount;a++)this.resolveContact(this.contacts[a],this.a,this.b)},resolveContact:function(a,b,c){var d=a.x-b.position.x,e=a.y-b.position.y,f=a.x-c.position.x,g=a.y-c.position.y,h=this.getRelativeVelocityX(a,b,c),i=this.getRelativeVelocityY(a,b,c),j=h*this.normal.x+i*this.normal.y;if(!(j>0)){var l=d*this.normal.y-e*this.normal.x,m=f*this.normal.y-g*this.normal.x,n=b.im+c.im+l*l*b.iI+m*m*c.iI,o=-(1+this.e)*j;if(o/=n,o/=this.contactCount,b.applyImpulse(-o*this.normal.x,-o*this.normal.y,d,e),c.applyImpulse(o*this.normal.x,o*this.normal.y,f,g),!this.noFriction){var p=h-this.normal.x*j,q=i-this.normal.y*j,r=Math.sqrt(p*p+q*q);r>k&&(p/=r,q/=r);var s=-(h*p+i*q);s/=n,s/=this.contactCount,Math.abs(s)<k||(Math.abs(s)<o*this.sf?(p*=s,q*=s):(p=p*-o*this.df,q=q*-o*this.df),b.applyImpulse(-p,-q,d,e),c.applyImpulse(p,q,f,g))}}},positionalCorrection:function(){var a=this.a,b=this.b,c=.8,d=.02,e=Math.max(this.penetration-d,0)/(a.im+b.im),f=e*this.normal.x*c,g=e*this.normal.y*c;a.position.x-=f*a.im,a.position.y-=g*a.im,b.position.x+=f*b.im,b.position.y+=g*b.im},getRelativeVelocityX:function(a,b,c){var d=a.x-b.velocity.x,e=a.x-c.velocity.x;return c.velocity.x+-c.angularVelocity*e-b.velocity.x- -b.angularVelocity*d},getRelativeVelocityY:function(a,b,c){var d=a.y-b.velocity.y,e=a.y-c.velocity.y;return c.velocity.y+c.angularVelocity*e-b.velocity.y-b.angularVelocity*d}},e.prototype={add:function(a){return new e(this.x+a.x,this.y+a.y)},sub:function(a){return new e(this.x-a.x,this.y-a.y)},dot:function(a){return this.x*a.x+this.y*a.y},cross:function(a){return this.x*a.y-this.y*a.x},div:function(a){return this.x/=a,this.y/=a,this},mul:function(a){return this.x*=a,this.y*=a,this},unit:function(){var a=this.length();if(a>1e-4){var b=1/a;return new e(this.x*b,this.y*b)}return new e(this.x,this.y)},normalize:function(){var a=this.length();if(a>1e-4){var b=1/a;this.x*=b,this.y*=b}},angle:function(){return Math.atan2(this.y,this.x)},lengthSqr:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},a.Vector2=e;var k=1e-4;f.EPSILON=k,f.prototype={update:function(a){var b,c;for(b=0;b<this.steps;b++)this.step(a*this.interp);for(b=0,c=this.dynamics.length;c>b;b++)this.dynamics[b].clearForces()},add:function(a){0!==a.im?this.dynamics.push(a):this.statics.push(a)},remove:function(a){this.statics.splice(this.statics.indexOf(a),1),this.dynamics.splice(this.dynamics.indexOf(a),1)},step:function(a){var b,c,d=this.dynamics.length;for(this.findContacts(),b=0;d>b;b++)this.dynamics[b].integrateForces(a,this.gravity),this.dynamics[b].clearContacts();for(c=0;c<this.contactCount;c++)this.contacts[c].setup(a,this.gravity);for(b=0;b<this.iterations;b++)for(c=0;c<this.contactCount;c++)this.contacts[c].resolve();for(b=0;d>b;b++)this.dynamics[b].integrateVelocity(a,this.gravity);for(c=0;c<this.contactCount;c++)this.contacts[c].positionalCorrection();for(b=0;d>b;b++)this.dynamics[b].update()},findContacts:function(){var a=this.dynamics.length,b=this.statics.length;this.contactCount=0;for(var c=0;a>c;c++){for(var d=this.dynamics[c],e=0;b>e;e++)this.checkContact(d,this.statics[e]);for(e=c+1;a>e;e++)this.checkContact(d,this.dynamics[e])}},checkContact:function(a,b){var c;a.isOverlapping(b)&&(this.contacts.length===this.contactCount?(c=new d,this.contacts.push(c)):c=this.contacts[this.contactCount],c.init(a,b)&&this.contactCount++)}},a.World=f,i(g,c,{update:function(){this.min.x=this.position.x-this.extend.x,this.max.x=this.position.x+this.extend.x,this.min.y=this.position.y-this.extend.y,this.max.y=this.position.y+this.extend.y,c.prototype.update.call(this)},isOverlapping:function(a){return this.max.x<a.min.x||this.min.x>a.max.x?!1:this.max.y<a.min.y||this.min.y>a.max.y?!1:!0},containsAABB:function(a){return this.min.x<=a.min.x&&this.max.x>=a.max.x&&this.min.y<=a.min.y&&this.max.y>=a.max.y},containsVector:function(a){return this.min.x<=a.x&&this.max.x>=a.x&&this.min.y<=a.y&&this.max.y>=a.y}}),a.AABB=g,h.AABBvsAABB=function(a,b,c){var d=b.position.x-c.position.x,e=b.position.y-c.position.y,f=(b.max.x-b.min.x)/2,g=(c.max.x-c.min.x)/2,h=f+g-Math.abs(d);if(h>0){var i=(b.max.y-b.min.y)/2,j=(c.max.y-c.min.y)/2,k=i+j-Math.abs(e);if(k){if(k>h){a.normal.x=0>d?1:-1,a.normal.y=0,a.penetration=h;var l=a.normal.x>0?c.min.x:c.max.x;return a.contacts[0].x=l,a.contacts[1].x=l,a.contacts[0].y=Math.max(c.min.y,b.min.y),a.contacts[1].y=Math.min(c.max.y,b.max.y),a.contactCount=2,!0}a.normal.x=0,a.normal.y=0>e?1:-1,a.penetration=k;var m=a.normal.y>0?c.min.y:c.max.y;return a.contacts[0].y=m,a.contacts[1].y=m,a.contacts[0].x=Math.max(c.min.x,b.min.x),a.contacts[1].x=Math.min(c.max.x,b.max.x),a.contactCount=2,!0}}return a.contactCount=0,!1},a.round=j,a.extend=i}("undefined"==typeof module?window.Box={}:module.exports);